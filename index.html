<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Memoralma de colores</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
  <style>
    html, body {
      margin: 0;
      padding: 0;
      font-family: 'Poppins', sans-serif;
      background: #fdf6f0;
      height: 100%;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    h1 {
      margin-top: 50px;
      color: #e94e77;
      font-size: clamp(1.5rem, 4vw, 2.5rem);
      text-align: center;
      font-weight: 600;
    }

    #level-indicator {
      font-size: clamp(1rem, 2vw, 1.5rem);
      margin: 10px;
      color: #555;
    }

    #game-container {
      flex-grow: 1;
      margin-top: -5vh;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      gap: 4vh;
    }

    .row {
      display: flex;
      gap: 3vw;
    }

    .color-btn {
      width: clamp(90px, 22vw, 150px);
      height: clamp(90px, 22vw, 150px);
      border-radius: 16px;
      border: none;
      opacity: 0.8;
      cursor: pointer;
      transition: 0.2s;
      box-shadow: 0 0 8px rgba(0,0,0,0.1);
    }

    .color-btn.active {
      opacity: 1;
      transform: scale(1.1);
      box-shadow: 0 0 20px rgba(0,0,0,0.3);
    }

    .btn {
      margin-top: 20px;
      padding: 10px 20px;
      font-size: 1rem;
      background: #e94e77;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      color: white;
      font-weight: 600;
    }

    #win-overlay, #lose-overlay, #start-overlay {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      display: none;
      align-items: center;
      justify-content: center;
      flex-direction: column;
      background: rgba(255, 255, 255, 0.9);
      z-index: 1000;
    }

    #win-overlay img {
      max-width: 80%;
      max-height: 550px;
      border: 4px solid #FFD1DC;
      border-radius: 12px;
    }

    canvas#confetti {
      position: fixed;
      top: 0;
      left: 0;
      pointer-events: none;
      z-index: 999;
    }
  </style>
</head>
<body>
  <h1>Recordá la secuencia para descubrir otra razón</h1>
  <div id="level-indicator">Ronda: 1</div>

  <div id="game-container" style="display:none;">
    <div class="row">
      <button class="color-btn" id="red" style="background:#f44336"></button>
      <button class="color-btn" id="green" style="background:#4caf50"></button>
    </div>
    <div class="row">
      <button class="color-btn" id="blue" style="background:#2196f3"></button>
      <button class="color-btn" id="yellow" style="background:#ffeb3b"></button>
    </div>
  </div>

  <div id="start-overlay" style="display:flex;">
    <button class="btn" onclick="startGame()">Iniciar juego</button>
  </div>

  <div id="win-overlay">
    <img src="historia.png" alt="Ganaste!">
    <button class="btn" onclick="startGame()">Volver a jugar</button>
  </div>

  <div id="lose-overlay">
    <h2 style="color: #e94e77;">Perdiste :(</h2>
    <button class="btn" onclick="startGame()">Volver a jugar</button>
  </div>

  <canvas id="confetti"></canvas>

  <script>
    const audioFiles = {
      red: new Audio('red.mp3'),
      green: new Audio('green.mp3'),
      blue: new Audio('blue.mp3'),
      yellow: new Audio('yellow.mp3'),
      win: new Audio('win.mp3'),
      lose: new Audio('lose.mp3')
    };

    function fadeOut(audio, duration = 400) {
      const steps = 20;
      const stepTime = duration / steps;
      const volumeStep = audio.volume / steps;
      let count = 0;
      const fading = setInterval(() => {
        count++;
        audio.volume = Math.max(0, audio.volume - volumeStep);
        if (count >= steps) {
          clearInterval(fading);
          audio.pause();
          audio.volume = 1;
        }
      }, stepTime);
    }

    async function playSound(color) {
      const original = audioFiles[color];
      if (!original) return;
      const clone = original.cloneNode();
      clone.volume = 1;
      try {
        await clone.play();
        const total = clone.duration * 1000;
        const fadeTime = 400;
        if (!isNaN(total) && total > fadeTime) {
          setTimeout(() => fadeOut(clone, fadeTime), total - fadeTime);
        }
      } catch (e) {
        console.warn('Error reproduciendo sonido:', e);
      }
    }

    const colorButtons = {
      red: document.getElementById('red'),
      green: document.getElementById('green'),
      blue: document.getElementById('blue'),
      yellow: document.getElementById('yellow')
    };

    const colorList = ['red', 'green', 'blue', 'yellow'];
    let sequence = [];
    let playerSequence = [];
    let level = 0;
    let acceptingInput = false;

    function flash(color) {
      const btn = colorButtons[color];
      btn.classList.add('active');
      playSound(color);
      setTimeout(() => btn.classList.remove('active'), 400);
    }

    function updateLevelIndicator() {
      document.getElementById('level-indicator').textContent = `Ronda: ${level}`;
    }

    async function showSequence() {
      acceptingInput = false;
      playerSequence = [];
      await new Promise(res => setTimeout(res, 1000));
      const delay = Math.max(600, 1200 - level * 150);
      for (let color of sequence) {
        flash(color);
        await new Promise(res => setTimeout(res, delay));
      }
      acceptingInput = true;
    }

    function nextLevel() {
      level++;
      updateLevelIndicator();
      const lengths = [3, 4, 5];
      sequence = Array.from({ length: lengths[level - 1] }, () => colorList[Math.floor(Math.random() * 4)]);
      showSequence();
    }

    function loseGame() {
      playSound('lose');
      acceptingInput = false;
      document.getElementById('lose-overlay').style.display = 'flex';
    }

    function winGame() {
      playSound('win');
      document.getElementById('win-overlay').style.display = 'flex';
      launchConfetti();
    }

    function checkInput(color) {
      if (!acceptingInput) return;
      playerSequence.push(color);
      flash(color);
      const idx = playerSequence.length - 1;
      if (playerSequence[idx] !== sequence[idx]) return loseGame();
      if (playerSequence.length === sequence.length) {
        level === 3 ? winGame() : setTimeout(nextLevel, 1000);
      }
    }

    Object.keys(colorButtons).forEach(color => {
      colorButtons[color].addEventListener('click', () => checkInput(color));
    });

    function startGame() {
      document.getElementById('start-overlay').style.display = 'none';
      document.getElementById('game-container').style.display = 'flex';
      document.getElementById('win-overlay').style.display = 'none';
      document.getElementById('lose-overlay').style.display = 'none';
      sequence = [];
      playerSequence = [];
      level = 0;
      updateLevelIndicator();
      nextLevel();
    }

    // Confetti
    const confettiCanvas = document.getElementById('confetti');
    const ctx = confettiCanvas.getContext('2d');
    let particles = [];

    function resizeCanvas() {
      confettiCanvas.width = innerWidth;
      confettiCanvas.height = innerHeight;
    }

    window.addEventListener('resize', resizeCanvas);
    resizeCanvas();

    function launchConfetti() {
      particles = [];
      for (let i = 0; i < 150; i++) {
        particles.push({
          x: Math.random() * innerWidth,
          y: Math.random() * innerHeight - innerHeight,
          r: Math.random() * 6 + 2,
          d: Math.random() * 10 + 5,
          color: `hsl(${Math.random() * 360},100%,70%)`,
          tilt: Math.random() * 10 - 10
        });
      }
      animateConfetti();
    }

    function animateConfetti() {
      ctx.clearRect(0, 0, innerWidth, innerHeight);
      particles.forEach(p => {
        ctx.beginPath();
        ctx.fillStyle = p.color;
        ctx.arc(p.x, p.y, p.r, 0, 2 * Math.PI);
        ctx.fill();
        p.y += p.d;
        p.x += Math.sin(p.tilt);
      });
      if (particles.some(p => p.y < innerHeight)) requestAnimationFrame(animateConfetti);
    }
  </script>
</body>
</html>
